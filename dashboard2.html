<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Dashboard</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>📊</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <style>
        .modal-content::-webkit-scrollbar { width: 8px; }
        .modal-content::-webkit-scrollbar-track { background: #374151; }
        .modal-content::-webkit-scrollbar-thumb { background: #9ca3af; border-radius: 4px; }
        .modal-content::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        .hidden { display: none; }
        .toast-wrapper { position: fixed; z-index: 100; padding: 1rem; width: 100%; max-width: 24rem; pointer-events: none; }
        .toast-wrapper > div { pointer-events: auto; }
        .top-right { top: 0; right: 0; }
        @keyframes fade-in-up { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fade-out-down { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(20px); } }
        .animate-fade-in-up { animation: fade-in-up 0.5s ease-out forwards; }
        .animate-fade-out-down { animation: fade-out-down 0.5s ease-in forwards; }
        .blackout { color: #4a5568 !important; background-color: #4a5568 !important; border-radius: 4px; user-select: none; }
    </style>
</head>
<body class="bg-gray-900 text-white font-sans">
    <div class="container mx-auto p-4">
        <div id="pageLoader" class="text-center mt-20">
            <h1 class="text-3xl font-bold text-yellow-400">Loading Dashboard...</h1>
            <p id="loadingError" class="text-red-500 mt-4"></p>
        </div>
        <div id="loginContainer" class="hidden max-w-md mx-auto mt-20 bg-gray-800 p-8 rounded-lg shadow-xl">
            <h1 class="text-3xl font-bold text-yellow-400 mb-6 text-center">Teacher Dashboard</h1>
            <div id="g_id_onload" data-client_id="1032478689007-9gk70vsn7i58l6f0qn5sr8q78sne1al5.apps.googleusercontent.com" data-callback="handleCredentialResponse"></div>
            <div class="g_id_signin" data-type="standard" data-size="large" data-theme="filled_black" data-text="signin_with" data-shape="rectangular" data-logo_alignment="left"></div>
            <p id="loginError" class="text-red-500 mt-4 text-center"></p>
        </div>
        <div id="mainContainer" class="hidden">
            <div class="flex justify-between items-center mb-6">
                <h1 id="dashboardTitle" class="text-3xl font-bold text-yellow-400"></h1>
                <div class="flex items-center gap-4">
                    <a href="./assignments.html" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">&larr; All Assignments</a>
                    <button onclick="handleSignOut()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Sign Out</button>
                </div>
            </div>

            <div class="mb-4 p-4 bg-gray-800 rounded-lg">
                <div class="flex flex-wrap items-center gap-x-6 gap-y-4">
                    <div class="flex items-center gap-3">
                        <span class="font-semibold">Class:</span>
                        <div id="classLinksContainer" class="flex flex-wrap items-center gap-x-4 gap-y-2">
                            </div>
                    </div>
                    <div class="h-6 border-l border-gray-600 hidden md:block"></div>
                    <div class="flex items-center gap-2">
                        <label for="sortFilter" class="font-semibold">Sort by:</label>
                        <select id="sortFilter" onchange="changeSort(this.value)" class="bg-gray-700 border border-gray-600 rounded-md p-2 text-white">
                            <option value="lastName">Last Name</option>
                            <option value="firstName">First Name</option>
                            <option value="random-static">Random (Static)</option>
                            <option value="random-live">Random (Live)</option>
                        </select>
                    </div>
                    <div class="h-6 border-l border-gray-600 hidden md:block"></div>
                    <div class="flex items-center gap-4">
                        <label class="flex items-center"><input type="checkbox" id="hideNames" onchange="toggleDisplayOptions()" class="h-4 w-4 rounded border-gray-600 bg-gray-700 text-blue-600 focus:ring-blue-500"><span class="ml-2">Hide Names</span></label>
                        <label class="flex items-center"><input type="checkbox" id="showScores" onchange="toggleDisplayOptions()" class="h-4 w-4 rounded border-gray-600 bg-gray-700 text-blue-600 focus:ring-blue-500"><span class="ml-2">Show Scores</span></label>
                        <label class="flex items-center"><input type="checkbox" id="blackoutMode" onchange="toggleDisplayOptions()" class="h-4 w-4 rounded border-gray-600 bg-gray-700 text-blue-600 focus:ring-blue-500"><span class="ml-2">Blackout Mode</span></label>
                    </div>
                    <div class="h-6 border-l border-gray-600 hidden md:block"></div>
                    <div class="flex items-center gap-4">
                        <select id="exportTypeSelect" class="bg-gray-700 border border-gray-600 rounded-md p-2 text-white mr-2">
                            <option value="standard">Standard Export</option>
                            <option value="final-answers">Final Answers Only</option>
                            <option value="full">Full Export (All Attempts)</option>
                        </select>
                        <button id="exportButton" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Export to CSV</button>
                        <button id="regradeAllButton" onclick="regradeAllSubmissions()" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg">Regrade All</button>
                    </div>
                </div>
            </div>

            <div class="overflow-x-auto bg-gray-800 rounded-lg shadow">
                <table class="min-w-full divide-y divide-gray-700 table-fixed">
                    <thead id="tableHeader" class="bg-gray-700"></thead>
                    <tbody id="studentData" class="divide-y divide-gray-600"></tbody>
                </table>
            </div>
        </div>
    </div>
    <div id="submissionModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 max-w-4xl w-full">
            <div class="flex justify-between items-start mb-2">
                <h2 id="modalTitle" class="text-2xl font-bold text-yellow-400"></h2>
                <button onclick="closeModal()" class="text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
            </div>
             <div class="flex justify-end items-center mb-2">
                <label class="flex items-center text-sm">
                    <input type="checkbox" id="showAllAttemptsToggle" onchange="toggleShowAllAttempts(this.checked)" class="h-4 w-4 rounded border-gray-600 bg-gray-700 text-blue-600 focus:ring-blue-500">
                    <span class="ml-2">Show All Attempts</span>
                </label>
            </div>
            <div id="modalContent" class="modal-content max-h-[70vh] overflow-y-auto pr-4"></div>
        </div>
    </div>
    <div id="toast-wrapper-top-right" class="toast-wrapper top-right space-y-3"></div>
<script>
    // ---- Firebase setup ----
    const TEACHER_EMAILS = ["klynch@mtps.us", "mstuart@mtps.us", "cfiori@mtps.us", "mlock@mtps.us", "cheine@mtps.us"];
    const firebaseConfig = {
      apiKey: "AIzaSyBnw3xU5aOSExv6dx7Kr-k2pvCXzn_1UyY",
      authDomain: "mrlynch-slides-app.firebaseapp.com",
      projectId: "mrlynch-slides-app",
      storageBucket: "mrlynch-slides-app.appspot.com",
      messagingSenderId: "223179627035",
      appId: "1:223179627035:web:ff0f538f3029d829c3f6be"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // --- Global State ---
    let assignmentData = null;
    let allStudentData = [];
    let studentDataMap = {}; // email -> studentData
    let activeClass = null;
    let assignmentId;
    let classAverages = {};
    let initialized = false;
    
    // Display & Sort State
    let hideNames = false;
    let showScores = false;
    let blackoutMode = false;
    let sortMode = 'lastName';
    let staticRandomOrder = [];
    let showAllAttempts = localStorage.getItem('dashboardShowAllAttempts') === 'true';
    let currentModalView = null;

    // --- Firestore live listener handles ---
    let unsubscribeStudents = null;
    let unsubscribeSubmissions = null;
    let unsubscribeStatus = null;

    window.onload = function() {
        const urlParams = new URLSearchParams(window.location.search);
        assignmentId = urlParams.get('assignmentId');
        if (!assignmentId) {
            document.getElementById('loadingError').textContent = "Error: No assignment ID provided in the URL.";
            return;
        }
        auth.onAuthStateChanged(user => {
            if (user) {
                if (TEACHER_EMAILS.includes(user.email)) { loadDashboard(); } 
                else {
                    document.getElementById('pageLoader').classList.add('hidden');
                    document.getElementById('loadingError').textContent = "Access Denied: You are not authorized to view this page.";
                    auth.signOut();
                }
            } else {
                document.getElementById('pageLoader').classList.add('hidden');
                document.getElementById('loginContainer').classList.remove('hidden');
            }
        });
        document.getElementById('exportButton').onclick = exportToCSV;
    };

    // --- SETUP LIVE LISTENERS ---
    function setupLiveStudentData() {
        if (unsubscribeStudents) unsubscribeStudents();
        if (unsubscribeSubmissions) unsubscribeSubmissions();
        if (unsubscribeStatus) unsubscribeStatus();

        unsubscribeStudents = db.collection("students").onSnapshot(studentSnapshot => {
            studentDataMap = {};
            allStudentData = studentSnapshot.docs.map(doc => {
                const data = { ...doc.data(), submissions: [], isSubmitted: false };
                studentDataMap[data.email] = data;
                return data;
            });

            unsubscribeSubmissions = db.collection("submissions")
                .where("assignmentId", "==", assignmentId)
                .onSnapshot(submissionSnapshot => {
                    submissionSnapshot.docChanges().forEach(change => {
                        const subData = { id: change.doc.id, ...change.doc.data() };
                        const student = studentDataMap[subData.studentEmail];
                        if (!student) return;

                        student.submissions = student.submissions.filter(s => s.id !== subData.id);
                        student.submissions.push(subData);
                        student.submissions.sort((a, b) => (a.slideIndex - b.slideIndex) || ((b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0)));

                        if (activeClass === 'All' || String(student.class) === String(activeClass)) {
                            updateStudentRow(subData.studentEmail);
                        }
                        calculateAllClassAverages();
                        updateClassAvgDisplay();
                    });
                });

            unsubscribeStatus = db.collection("submissionStatus")
                .where("assignmentId", "==", assignmentId)
                .where("status", "==", "submitted")
                .onSnapshot(statusSnapshot => {
                    const submittedEmails = new Set(statusSnapshot.docs.map(doc => doc.data().studentEmail));
                     Object.values(studentDataMap).forEach(student => {
                        const before = student.isSubmitted;
                        student.isSubmitted = submittedEmails.has(student.email);
                        if (student.isSubmitted !== before) {
                            if (activeClass === 'All' || String(student.class) === String(activeClass)) {
                                updateStudentRow(student.email);
                            }
                        }
                    });
                });

            // PATCH: Set activeClass to first class after data loads, only once
            const assignedClasses = assignmentData.assignedClasses || [];
            const classesInAssignment = [...new Set(allStudentData.filter(s => assignedClasses.includes(String(s.class))).map(s => String(s.class)))].sort((a, b) => a.localeCompare(b, undefined, { numeric: true }));
            if (!initialized && classesInAssignment.length > 0) {
                activeClass = classesInAssignment[0];
                initialized = true;
            }

            calculateAllClassAverages();
            populateClassLinks();
            displayStudentTable();
        });
    }

    // --- CLEANUP LISTENERS ---
    function cleanupListeners() {
        if (unsubscribeStudents) unsubscribeStudents();
        if (unsubscribeSubmissions) unsubscribeSubmissions();
        if (unsubscribeStatus) unsubscribeStatus();
    }
    window.addEventListener("beforeunload", cleanupListeners);
    
    // --- DASHBOARD LOAD ---
    async function loadDashboard() {
        try {
            const doc = await db.collection("assignments").doc(assignmentId).get();
            if (!doc.exists) {
                document.getElementById('loadingError').textContent = "Error: This assignment could not be found.";
                return;
            }
            assignmentData = { id: doc.id, ...doc.data() };
            document.title = assignmentData.name + " - Dashboard";
            document.getElementById('dashboardTitle').textContent = `Dashboard for: ${assignmentData.name}`;
            
            setupLiveStudentData(); // <-- Live updates!

            document.getElementById('pageLoader').classList.add('hidden');
            document.getElementById('mainContainer').classList.remove('hidden');
        } catch (error) {
            console.error("Error loading dashboard:", error);
            document.getElementById('loadingError').textContent = "An error occurred while loading the dashboard.";
        }
    }

    // --- Handle Sign Out with Cleanup ---
    function handleSignOut() { 
        cleanupListeners();
        auth.signOut().then(() => window.location.reload()); 
    }

    function calculateAllClassAverages() {
        const averages = {};
        const assignedClasses = assignmentData.assignedClasses || [];
        const studentsInAssignment = Object.values(studentDataMap).filter(s => assignedClasses.includes(String(s.class)));
        const numQuestions = assignmentData.slideIds.length;

        const classes = [...new Set(studentsInAssignment.map(s => String(s.class)))];
        classes.forEach(c => {
            const studentsInClass = studentsInAssignment.filter(s => String(s.class) === c);
            let totalScore = 0;
            let attemptedQuestions = 0;
            studentsInClass.forEach(student => {
                for (let i = 0; i < numQuestions; i++) {
                    const latestSubmission = student.submissions.filter(sub => sub.slideIndex === i).sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0))[0];
                    if (latestSubmission) {
                        totalScore += latestSubmission.score;
                        attemptedQuestions++;
                    }
                }
            });
            averages[c] = attemptedQuestions > 0 ? (totalScore / attemptedQuestions).toFixed(0) : '-';
        });

        let allTotalScore = 0;
        let allAttemptedQuestions = 0;
        studentsInAssignment.forEach(student => {
             for (let i = 0; i < numQuestions; i++) {
                const latestSubmission = student.submissions.filter(s => s.slideIndex === i).sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0))[0];
                if (latestSubmission) {
                    allTotalScore += latestSubmission.score;
                    allAttemptedQuestions++;
                }
            }
        });
        averages['All'] = allAttemptedQuestions > 0 ? (allTotalScore / allAttemptedQuestions).toFixed(0) : '-';
        classAverages = averages;
    }

    function populateClassLinks() {
        const linksContainer = document.getElementById('classLinksContainer');
        linksContainer.innerHTML = '';
        const assignedClasses = assignmentData.assignedClasses || [];
        const classesInAssignment = [...new Set(Object.values(studentDataMap).filter(s => assignedClasses.includes(String(s.class))).map(s => String(s.class)))].sort((a, b) => a.localeCompare(b, undefined, { numeric: true }));
        
        classesInAssignment.forEach(c => {
            const isActive = activeClass === c;
            const activeClasses = isActive ? 'text-yellow-400 font-bold underline' : 'text-gray-300 hover:text-white';
            linksContainer.innerHTML += `<a href="#" data-class-name="${c}" onclick="event.preventDefault(); filterByClass('${c}')" class="class-link text-sm ${activeClasses}">${c}</a>`;
        });
        
        const isAllActive = activeClass === 'All';
        const allActiveClasses = isAllActive ? 'text-yellow-400 font-bold underline' : 'text-gray-300 hover:text-white';
        linksContainer.innerHTML += `<a href="#" data-class-name="All" onclick="event.preventDefault(); filterByClass('All')" class="class-link text-sm ${allActiveClasses}">All Classes</a>`;
        
        const activeAvg = classAverages[activeClass] || '-';
        linksContainer.innerHTML += `<span id="activeClassAvg" class="class-avg text-xs ml-2 text-cyan-400 ${!showScores ? 'hidden' : ''}">(Avg: ${activeAvg})</span>`;
    }

    function updateClassAvgDisplay() {
        const avgEl = document.getElementById('activeClassAvg');
        if (avgEl) {
            const activeAvg = classAverages[activeClass] || '-';
            avgEl.textContent = `(Avg: ${activeAvg})`;
        }
    }

    function filterByClass(className) {
        activeClass = className;
        document.querySelectorAll('.class-link').forEach(link => {
            const isActive = link.dataset.className === activeClass;
            link.classList.toggle('text-yellow-400', isActive);
            link.classList.toggle('font-bold', isActive);
            link.classList.toggle('underline', isActive);
            link.classList.toggle('text-gray-300', !isActive);
            link.classList.toggle('hover:text-white', !isActive);
        });
        updateClassAvgDisplay();
        changeSort(sortMode); // This will call displayStudentTable
    }

    function changeSort(newMode) {
        sortMode = newMode;
        if (sortMode === 'random-static') {
            const studentsInView = getCurrentlySortedStudents(false); // get without sorting
            staticRandomOrder = [...studentsInView].sort(() => Math.random() - 0.5);
        }
        displayStudentTable();
    }

    function toggleDisplayOptions() {
        hideNames = document.getElementById('hideNames').checked;
        showScores = document.getElementById('showScores').checked;
        blackoutMode = document.getElementById('blackoutMode').checked;
        
        const avgEl = document.getElementById('activeClassAvg');
        if (avgEl) avgEl.classList.toggle('hidden', !showScores);
        
        displayStudentTable();
    }

    function getCurrentlySortedStudents(applySort = true) {
        const assignedClasses = assignmentData.assignedClasses || [];
        const studentsInAssignment = Object.values(studentDataMap).filter(s => assignedClasses.includes(String(s.class)));
        const filteredStudents = (activeClass === 'All' ? studentsInAssignment : studentsInAssignment.filter(s => String(s.class) === String(activeClass)));
        
        if (!applySort) return filteredStudents;

        let sortedStudents = [...filteredStudents];
        switch (sortMode) {
            case 'firstName':
                sortedStudents.sort((a, b) => a.name.localeCompare(b.name));
                break;
            case 'lastName':
                sortedStudents.sort((a, b) => (a.name.split(' ').pop() || '').localeCompare(b.name.split(' ').pop() || ''));
                break;
            case 'random-live':
                sortedStudents.sort(() => Math.random() - 0.5);
                break;
            case 'random-static':
                const currentEmails = new Set(filteredStudents.map(s => s.email));
                sortedStudents = staticRandomOrder.filter(s => currentEmails.has(s.email));
                break;
        }
        return sortedStudents;
    }

    function displayStudentTable() {
        const tableHeader = document.getElementById('tableHeader');
        const studentList = document.getElementById('studentData');
        const numQuestions = assignmentData.slideIds.length;
        const sortedStudents = getCurrentlySortedStudents();

        // --- Render Header ---
        let headerHtml = `<tr> <th class="px-3 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider w-64">Student Name</th> <th class="px-2 py-3 text-center text-xs font-medium text-gray-300 uppercase tracking-wider w-20">Submitted</th>`;
        for (let i = 1; i <= numQuestions; i++) {
            headerHtml += `<th class="px-2 py-3 text-center text-xs font-medium text-gray-300 uppercase tracking-wider cursor-pointer hover:text-yellow-400" onclick="showQuestionSubmissions(${i - 1})">Q${i}</th>`;
        }
        headerHtml += '</tr>';
        
        // --- Render Class Average Row ---
        if (showScores) {
            let classAverageRowHtml = `<tr><td class="text-xs font-semibold text-cyan-400 px-3">Class Average:</td><td class="px-2"></td>`;
            for (let i = 0; i < numQuestions; i++) {
                const scores = sortedStudents
                    .map(s => s.submissions.filter(sub => sub.slideIndex === i).sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0))[0])
                    .filter(Boolean) // Remove undefined/null latest submissions
                    .map(sub => sub.score);
                const avg = scores.length > 0 ? (scores.reduce((a, b) => a + b, 0) / scores.length).toFixed(0) : '-';
                classAverageRowHtml += `<td class="text-center text-xs font-semibold text-cyan-400">${avg}</td>`;
            }
            classAverageRowHtml += '</tr>';
            headerHtml += classAverageRowHtml;
        }
        tableHeader.innerHTML = headerHtml;
        
        // --- Render Student Rows ---
        studentList.innerHTML = sortedStudents.map(student => generateStudentRowHtml(student)).join('');
    }

    function updateStudentRow(studentEmail) {
        const student = studentDataMap[studentEmail];
        if (!student) return;

        const existingRow = document.getElementById(`student-row-${student.email.replace(/[@.]/g, '-')}`);
        const newRowHtml = generateStudentRowHtml(student);

        if (existingRow) {
            existingRow.outerHTML = newRowHtml;
        } else {
            // This case is less likely with the new full-table-render approach, but good for safety
            document.getElementById('studentData').insertAdjacentHTML('beforeend', newRowHtml);
        }
    }
    
    function generateStudentRowHtml(student) {
        const numQuestions = assignmentData.slideIds.length;
        const studentName = student.name || 'Unknown Student';
        let studentRow = `<tr id="student-row-${student.email.replace(/[@.]/g, '-')}">`;

        const nameClass = blackoutMode ? 'blackout' : '';
        studentRow += `<td class="px-3 py-2 whitespace-nowrap"><span class="${nameClass} cursor-pointer hover:text-yellow-400" onclick="showStudentSubmissions('${student.email}')">${hideNames ? 'Student' : studentName}</span></td>`;
        studentRow += `<td class="px-2 py-2 text-center">${student.isSubmitted ? '✔️' : '...'}</td>`;

        for (let i = 0; i < numQuestions; i++) {
            const latestSubmission = student.submissions.filter(s => s.slideIndex === i).sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0))[0];
            let cellContent = '-';
            let cellClass = '';
            if (latestSubmission) {
                const score = latestSubmission.score;
                cellContent = showScores ? score : '✔️';
                if (score >= 90) cellClass = 'bg-green-800 bg-opacity-50';
                else if (score >= 80) cellClass = 'bg-yellow-700 bg-opacity-50';
                else if (score >= 70) cellClass = 'bg-orange-700 bg-opacity-50';
                else cellClass = 'bg-red-800 bg-opacity-50';
            }
            studentRow += `<td class="px-2 py-2 text-center ${cellClass}"><div class="${blackoutMode ? 'blackout' : ''}">${cellContent}</div></td>`;
        }
        studentRow += '</tr>';
        return studentRow;
    }

    // --- EXPORT FUNCTIONS ---
    function exportToCSV() {
        const exportType = document.getElementById('exportTypeSelect').value;
        switch (exportType) {
            case 'standard':
                exportStandard();
                break;
            case 'final-answers':
                exportFinalAnswers();
                break;
            case 'full':
                exportFull();
                break;
        }
    }

    function exportStandard() {
        const studentsToExport = getCurrentlySortedStudents();
        const numQuestions = assignmentData.slideIds.length;
        let csvContent = "data:text/csv;charset=utf-8,";
        
        let headers = ["Email", "Last Name", "First Name", "Last, First", "Class", "Average Score", "Completion %"];
        for (let i = 1; i <= numQuestions; i++) { headers.push(`Q${i} Score`); }
        csvContent += headers.join(',') + "\r\n";

        studentsToExport.forEach(student => {
            const nameParts = student.name.split(' ');
            const firstName = nameParts[0] || '';
            const lastName = nameParts.slice(1).join(' ') || '';
            const lastFirst = `"${lastName}, ${firstName}"`;
            
            let totalScore = 0;
            let attemptedQuestions = 0;
            let questionScores = [];
            for (let i = 0; i < numQuestions; i++) {
                const latestSubmission = student.submissions.filter(s => s.slideIndex === i).sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0))[0];
                if (latestSubmission) {
                    questionScores.push(latestSubmission.score);
                    totalScore += latestSubmission.score;
                    attemptedQuestions++;
                } else {
                    questionScores.push("");
                }
            }
            const averageScore = attemptedQuestions > 0 ? (totalScore / attemptedQuestions).toFixed(2) : "";
            const completionPercentage = numQuestions > 0 ? ((attemptedQuestions / numQuestions) * 100).toFixed(2) : "0.00";
            let row = [student.email, `"${lastName}"`, `"${firstName}"`, lastFirst, student.class, averageScore, completionPercentage, ...questionScores].join(',');
            csvContent += row + "\r\n";
        });
        
        downloadCSV(csvContent, "export_standard");
    }

    function exportFinalAnswers() {
        const studentsToExport = getCurrentlySortedStudents();
        const numQuestions = assignmentData.slideIds.length;
        let csvContent = "data:text/csv;charset=utf-8,";

        let headers = ["Email", "Last Name", "First Name", "Class"];
        for (let i = 1; i <= numQuestions; i++) {
            headers.push(`Q${i} Score`);
            headers.push(`Q${i} Final Answer`);
        }
        csvContent += headers.join(',') + "\r\n";

        studentsToExport.forEach(student => {
            const nameParts = student.name.split(' ');
            const firstName = nameParts[0] || '';
            const lastName = nameParts.slice(1).join(' ') || '';
            
            let rowData = [student.email, `"${lastName}"`, `"${firstName}"`, student.class];
            for (let i = 0; i < numQuestions; i++) {
                const latestSubmission = student.submissions.filter(s => s.slideIndex === i).sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0))[0];
                if (latestSubmission) {
                    rowData.push(latestSubmission.score);
                    rowData.push(`"${latestSubmission.answer.replace(/"/g, '""')}"`);
                } else {
                    rowData.push("", ""); // Score, Answer
                }
            }
            csvContent += rowData.join(',') + "\r\n";
        });
        downloadCSV(csvContent, "export_final_answers");
    }

    function exportFull() {
        const studentsToExport = getCurrentlySortedStudents();
        let csvContent = "data:text/csv;charset=utf-8,";
        csvContent += "Email,Last Name,First Name,Class,Question #,Score,Answer,Timestamp\r\n";

        studentsToExport.forEach(student => {
            const nameParts = student.name.split(' ');
            const firstName = nameParts[0] || '';
            const lastName = nameParts.slice(1).join(' ') || '';

            if (student.submissions.length === 0) {
                 let row = [student.email, `"${lastName}"`, `"${firstName}"`, student.class, "", "", "", ""].join(',');
                 csvContent += row + "\r\n";
            } else {
                 student.submissions.forEach(sub => {
                    const timestampStr = sub.timestamp ? new Date(sub.timestamp.seconds * 1000).toLocaleString() : 'N/A';
                    const idx = sub.slideIndex;
                    let row = [
                        student.email,
                        `"${lastName}"`,
                        `"${firstName}"`,
                        student.class,
                        idx + 1,
                        sub.score,
                        `"${sub.answer.replace(/"/g, '""')}"`,
                        `"${timestampStr}"`
                    ].join(',');
                    csvContent += row + "\r\n";
                });
            }
        });
        downloadCSV(csvContent, "export_full");
    }

    function downloadCSV(csvContent, typeSuffix) {
        const blob = new Blob([csvContent.substring(24)], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        const safeAssignmentName = assignmentData.name.replace(/[^a-z0-9]/gi, '_');
        const safeViewName = activeClass.replace(/\s+/g, '_');
        link.setAttribute("download", `${typeSuffix}_${safeAssignmentName}_${safeViewName}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
    }
    
    // --- MODAL AND GRADING CODE (Retained from Original) ---
    // (The following functions are from the original file and are necessary for modal and grading functionality)

    function showToast(message, type = 'success') {
        const wrapper = document.getElementById('toast-wrapper-top-right');
        const toastId = 'toast-' + Date.now();
        const bgColor = type === 'success' ? 'bg-green-600' : 'bg-red-600';

        const toastElement = document.createElement('div');
        toastElement.id = toastId;
        toastElement.className = `transform transition-all w-full p-4 rounded-md shadow-lg ${bgColor} text-white animate-fade-in-up`;
        toastElement.innerHTML = `<p class="font-bold">${type === 'success' ? 'Success' : 'Error'}</p><p>${message}</p>`;
        
        wrapper.appendChild(toastElement);

        setTimeout(() => {
            const toast = document.getElementById(toastId);
            if(toast) {
                toast.classList.remove('animate-fade-in-up');
                toast.classList.add('animate-fade-out-down');
                toast.addEventListener('animationend', () => toast.remove());
            }
        }, 5000);
    }

    async function showStudentSubmissions(studentEmail) {
        const student = studentDataMap[studentEmail];
        if (!student) return;
        currentModalView = { type: 'student', email: studentEmail };
        renderModalContent();
    }
    
    async function showQuestionSubmissions(questionIndex) {
        currentModalView = { type: 'question', index: questionIndex };
        renderModalContent();
    }

    function renderModalContent() {
        if (!currentModalView) return;

        const modal = document.getElementById('submissionModal');
        const titleEl = document.getElementById('modalTitle');
        const contentEl = document.getElementById('modalContent');
        const toggleEl = document.getElementById('showAllAttemptsToggle');

        toggleEl.checked = showAllAttempts;
        contentEl.innerHTML = '<p class="text-center">Loading submissions...</p>';
        modal.classList.remove('hidden');

        if (currentModalView.type === 'student') {
            const student = studentDataMap[currentModalView.email];
            titleEl.textContent = `Submissions for: ${student.name}`;
            renderStudentModalView(student);
        } else if (currentModalView.type === 'question') {
            titleEl.textContent = `Submissions for Question ${currentModalView.index + 1}`;
            renderQuestionModalView(currentModalView.index);
        }
    }
    
    function renderStudentModalView(student) {
        const contentEl = document.getElementById('modalContent');
        const numQuestions = assignmentData.slideIds.length;
        let html = '';

        for (let i = 0; i < numQuestions; i++) {
            const submissionsForQuestion = student.submissions.filter(s => s.slideIndex === i).sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
            html += `<div class="mb-6 p-4 bg-gray-700 rounded-lg">`;
            html += `<h3 class="text-xl font-bold text-yellow-400 mb-3 border-b border-gray-600 pb-2">Question ${i + 1}</h3>`;

            if (submissionsForQuestion.length === 0) {
                html += `<p class="text-gray-400">No submission for this question.</p></div>`;
                continue;
            }

            const submissionsToShow = showAllAttempts ? submissionsForQuestion : [submissionsForQuestion[0]];
            submissionsToShow.forEach((sub, index) => {
                const isLatest = index === 0;
                const timestamp = sub.timestamp ? new Date(sub.timestamp.seconds * 1000).toLocaleString() : 'N/A';
                const scoreColor = sub.score >= 90 ? 'text-green-400' : sub.score >= 70 ? 'text-yellow-400' : 'text-red-400';
                
                html += `<div class="p-3 ${isLatest ? 'border-l-4 border-yellow-400' : 'opacity-70'} bg-gray-800 rounded-md mb-3">`;
                html += `<div class="flex justify-between items-center mb-2">`;
                html += `<div><span class="font-semibold">Score: <span class="font-bold text-lg ${scoreColor}">${sub.score}</span></span>`;
                html += `<span class="text-xs text-gray-400 ml-4">${timestamp} ${isLatest && !showAllAttempts ? '(Latest)' : ''}</span></div>`;
                html += `<div class="flex items-center gap-2">
                            <input type="number" id="score-${sub.id}" value="${sub.score}" class="w-20 bg-gray-900 border border-gray-600 rounded-md p-1 text-white text-center">
                            <button onclick="setScore('${sub.id}', '${student.email}')" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-1 px-3 rounded-md text-sm">Set</button>
                         </div>`;
                html += `</div>`;
                html += `<div class="mt-2"><p class="font-semibold mb-1">Answer:</p><textarea id="answer-${sub.id}" rows="3" class="w-full bg-gray-900 border border-gray-600 rounded-md p-2 text-white">${sub.answer}</textarea></div>`;
                html += `<button onclick="saveAnswer('${sub.id}', '${student.email}')" class="mt-2 bg-green-600 hover:bg-green-700 text-white font-bold py-1 px-3 rounded-md text-sm">Save Answer</button>`;
                html += `</div>`;
            });
            html += `</div>`;
        }
        contentEl.innerHTML = html;
    }

    function renderQuestionModalView(questionIndex) {
        const contentEl = document.getElementById('modalContent');
        let html = '';
        const studentsInView = getCurrentlySortedStudents();

        studentsInView.forEach(student => {
            const submissionsForQuestion = student.submissions.filter(s => s.slideIndex === questionIndex).sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
            if (submissionsForQuestion.length === 0 && !showAllAttempts) return;

            html += `<div class="mb-4 p-3 bg-gray-700 rounded-lg">`;
            html += `<h4 class="text-lg font-semibold text-white mb-2">${student.name}</h4>`;
            
            if (submissionsForQuestion.length === 0) {
                html += `<p class="text-gray-400">No submission.</p></div>`;
                return;
            }

            const submissionsToShow = showAllAttempts ? submissionsForQuestion : [submissionsForQuestion[0]];
            submissionsToShow.forEach((sub, index) => {
                 const isLatest = index === 0;
                const timestamp = sub.timestamp ? new Date(sub.timestamp.seconds * 1000).toLocaleString() : 'N/A';
                const scoreColor = sub.score >= 90 ? 'text-green-400' : sub.score >= 70 ? 'text-yellow-400' : 'text-red-400';
                
                html += `<div class="p-3 ${isLatest ? 'border-l-4 border-yellow-400' : 'opacity-70'} bg-gray-800 rounded-md mb-2">`;
                html += `<div class="flex justify-between items-center mb-2">`;
                html += `<div><span class="font-semibold">Score: <span class="font-bold text-lg ${scoreColor}">${sub.score}</span></span>`;
                html += `<span class="text-xs text-gray-400 ml-4">${timestamp} ${isLatest && !showAllAttempts ? '(Latest)' : ''}</span></div>`;
                html += `<div class="flex items-center gap-2">
                            <input type="number" id="score-${sub.id}" value="${sub.score}" class="w-20 bg-gray-900 border border-gray-600 rounded-md p-1 text-white text-center">
                            <button onclick="setScore('${sub.id}', '${student.email}')" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-1 px-3 rounded-md text-sm">Set</button>
                         </div>`;
                html += `</div>`;
                html += `<div class="mt-2"><p class="font-semibold mb-1">Answer:</p><p class="whitespace-pre-wrap p-2 bg-gray-900 rounded-md">${sub.answer}</p></div>`;
                html += `</div>`;
            });
            html += `</div>`;
        });
        contentEl.innerHTML = html || '<p class="text-center text-gray-400">No submissions to display for this question in the current view.</p>';
    }

    function closeModal() {
        document.getElementById('submissionModal').classList.add('hidden');
        currentModalView = null;
    }

    function toggleShowAllAttempts(isChecked) {
        showAllAttempts = isChecked;
        localStorage.setItem('dashboardShowAllAttempts', isChecked);
        if (currentModalView) {
            renderModalContent();
        }
    }
    
    async function regradeAllSubmissions() {
        if (!confirm("Are you sure you want to regrade all submissions for this assignment? This cannot be undone.")) return;

        const regradeButton = document.getElementById('regradeAllButton');
        regradeButton.disabled = true;
        regradeButton.textContent = 'Regrading...';

        try {
            const submissionsSnapshot = await db.collection("submissions").where("assignmentId", "==", assignmentId).get();
            const batch = db.batch();
            let count = 0;

            submissionsSnapshot.forEach(doc => {
                const subRef = db.collection("submissions").doc(doc.id);
                batch.update(subRef, { needsRegrade: true });
                count++;
                if (count % 499 === 0) { // Firestore batch limit is 500
                    batch.commit();
                    batch = db.batch();
                }
            });
            await batch.commit();

            showToast(`Successfully queued ${submissionsSnapshot.size} submissions for regrading.`, 'success');
        } catch (error) {
            console.error("Error regrading submissions: ", error);
            showToast('Error queuing submissions for regrading.', 'error');
        } finally {
            regradeButton.disabled = false;
            regradeButton.textContent = 'Regrade All';
        }
    }

    async function setScore(submissionId, studentEmail) {
        const scoreInput = document.getElementById(`score-${submissionId}`);
        const newScore = parseInt(scoreInput.value, 10);
        if (isNaN(newScore) || newScore < 0 || newScore > 100) {
            showToast("Invalid score. Please enter a number between 0 and 100.", 'error');
            return;
        }

        try {
            await db.collection("submissions").doc(submissionId).update({ score: newScore });
            showToast("Score updated successfully!", 'success');
            // No need for a full re-render, the live listener will catch this
        } catch (error) {
            console.error("Error updating score:", error);
            showToast("Failed to update score.", 'error');
        }
    }
    
    async function saveAnswer(submissionId, studentEmail) {
        const answerTextarea = document.getElementById(`answer-${submissionId}`);
        const newAnswer = answerTextarea.value;
        
        try {
            await db.collection("submissions").doc(submissionId).update({ answer: newAnswer, needsRegrade: true });
            showToast("Answer saved and queued for regrading!", 'success');
        } catch (error) {
            console.error("Error saving answer:", error);
            showToast("Failed to save answer.", 'error');
        }
    }

</script>
</body>
</html>
