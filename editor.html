<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assignment Editor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Both Google scripts are needed: GSI for sign-in, GAPI for API calls -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js" async defer></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    <style>
        .hidden { display: none; }
        textarea { font-family: monospace; resize: vertical; }
        #toast { visibility: hidden; min-width: 250px; margin-left: -125px; background-color: #333; color: #fff; text-align: center; border-radius: 4px; padding: 16px; position: fixed; z-index: 10; left: 50%; bottom: 30px; font-size: 17px; }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px, opacity: 1;} to {bottom: 0, opacity: 0;} }
    </style>
</head>
<body class="bg-gray-900 text-white font-sans">

    <!-- SIGN-IN & LOADING STATES -->
    <div id="page-loader" class="flex flex-col items-center justify-center h-screen">
        <h1 class="text-4xl font-bold text-yellow-400 mb-4">Assignment Editor</h1>
        <p id="loading-text" class="text-lg text-gray-300">Please sign in to continue...</p>
        <div id="signInButtonContainer" class="mt-8">
             <div id="g_id_onload" data-client_id="1032478689007-9gk70vsn7i58l6f0qn5sr8q78sne1al5.apps.googleusercontent.com" data-callback="handleCredentialResponse" data-auto_select="true" data-use_fedcm_for_prompt="false"></div>
             <div class="g_id_signin" data-type="standard" data-size="large" data-theme="filled_black" data-text="signin_with" data-shape="rectangular" data-logo_alignment="left"></div>
        </div>
        <p id="auth-error" class="text-red-500 mt-4"></p>
    </div>

    <!-- MAIN EDITOR CONTENT -->
    <div id="editorContent" class="hidden container mx-auto p-4 md:p-8">
        <div class="flex justify-between items-center mb-6 flex-wrap gap-4">
            <h1 id="assignmentTitle" class="text-3xl font-bold text-yellow-400"></h1>
            <div>
                <a href="./assignments.html" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">&larr; Back to Assignments</a>
                <button onclick="saveAssignment()" id="saveBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">Save Assignment</button>
                <button id="signOutButton" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Sign Out</button>
            </div>
        </div>

        <div class="bg-gray-800 p-4 rounded-lg mb-6">
            <h2 class="text-xl font-semibold mb-2">Student Link</h2>
            <p class="text-gray-400 mb-2">Share this link with your students to have them complete this assignment.</p>
            <input id="shareLink" type="text" readonly class="w-full p-2 bg-gray-700 border border-gray-600 rounded">
        </div>

        <div id="slidesContainer" class="space-y-8">
            <!-- Slides and editor boxes will be dynamically added here -->
        </div>
    </div>

    <div id="toast"></div>

<script>
    const TEACHER_EMAIL = "klynch@mtps.us";
    const CLIENT_ID = "1032478689007-9gk70vsn7i58l6f0qn5sr8q78sne1al5.apps.googleusercontent.com";
    const SCOPES = "https://www.googleapis.com/auth/presentations.readonly";
    const firebaseConfig = {
      apiKey: "AIzaSyBnw3xU5aOSExv6dx7Kr-k2pvCXzn_1UyY",
      authDomain: "mrlynch-slides-app.firebaseapp.com",
      projectId: "mrlynch-slides-app",
      storageBucket: "mrlynch-slides-app.appspot.com",
      messagingSenderId: "223179627035",
      appId: "1:223179627035:web:ff0f538f3029d829c3f6be"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let assignmentId = null;
    let assignmentData = null;
    let tokenClient;

    function decodeJwtResponse(token) { try { const base64Url = token.split('.')[1]; const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/'); const jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) { return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2); }).join('')); return JSON.parse(jsonPayload); } catch (e) { return null; } }

    function handleCredentialResponse(response) {
        const userProfile = decodeJwtResponse(response.credential);
        if (userProfile.email.toLowerCase() === TEACHER_EMAIL.toLowerCase()) {
            document.getElementById('signInButtonContainer').classList.add('hidden');
            document.getElementById('loading-text').textContent = "Authenticating...";
            // Get the OAuth token needed for the Slides API
            tokenClient.callback = (tokenResponse) => {
                if (tokenResponse && tokenResponse.access_token) {
                    gapi.client.setToken(tokenResponse);
                    loadAssignment();
                } else {
                     document.getElementById('loading-text').textContent = "Could not get authorization. Please try again.";
                }
            };
            tokenClient.requestAccessToken();
        } else {
            document.getElementById('loading-text').textContent = "Access Denied. Please sign in with the teacher account.";
            google.accounts.id.disableAutoSelect();
        }
    }
    
    window.onload = function() {
        const urlParams = new URLSearchParams(window.location.search);
        assignmentId = urlParams.get('id');
        if (!assignmentId) {
            document.getElementById('loading-text').textContent = "Error: No assignment ID provided in the URL.";
        }
        
        // Initialize the GAPI client for API calls
        gapi.load('client', function() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: '', // Will be set dynamically in handleCredentialResponse
            });
            gapi.client.load('https://slides.googleapis.com/$discovery/rest?version=v1');
        });
    };

    async function loadAssignment() {
        if (!assignmentId) return;
        const loadingText = document.getElementById('loading-text');
        
        try {
            loadingText.textContent = "Loading assignment data...";
            const doc = await db.collection("assignments").doc(assignmentId).get();
            if (!doc.exists) {
                loadingText.textContent = "Error: Assignment not found.";
                return;
            }
            assignmentData = { id: doc.id, ...doc.data() };
            
            loadingText.textContent = "Fetching slide information from Google...";
            
            // --- NEW: Automatically fetch slide IDs from Google Slides API ---
            const response = await gapi.client.slides.presentations.get({
                presentationId: assignmentData.presentationId,
            });
            
            const slides = response.result.slides;
            if (!slides || slides.length === 0) {
                loadingText.textContent = "Error: No slides found in the presentation.";
                return;
            }
            assignmentData.slideIds = slides.map(slide => slide.objectId);
            // --- END NEW ---

            document.getElementById('page-loader').classList.add('hidden');
            document.getElementById('editorContent').classList.remove('hidden');
            document.getElementById('assignmentTitle').textContent = `Editing: ${assignmentData.name}`;
            document.getElementById('shareLink').value = `https://custom.scienceclass.rocks/classroompicker.html?assignmentId=${assignmentId}`;

            renderEditor();

        } catch (error) {
            console.error("Error loading assignment or slides:", error);
            const errorMessage = error.result?.error?.message || "An unknown error occurred.";
            loadingText.textContent = `Error: ${errorMessage}. Please ensure Slides API is enabled and the presentation is shared with you.`;
        }
    }

    function renderEditor() {
        const container = document.getElementById('slidesContainer');
        container.innerHTML = '';
        
        let slideIds = assignmentData.slideIds || [];
        let checkerFunctions = assignmentData.checkerFunctions || {};

        if (slideIds.length === 0) {
            container.innerHTML = `<p class="text-center text-gray-400">No slides were found to generate the editor.</p>`;
            return;
        }

        slideIds.forEach((slideId, index) => {
            const slideEditorHTML = `
                <div class="slide-editor-box grid grid-cols-1 md:grid-cols-2 gap-6 bg-gray-800 p-4 rounded-lg">
                    <div>
                        <h3 class="text-xl font-semibold mb-2">Slide ${index + 1} <span class="text-xs text-gray-500">${slideId}</span></h3>
                        <img src="https://docs.google.com/presentation/d/${assignmentData.presentationId}/export/png?id=${assignmentData.presentationId}&pageid=${slideId}" class="w-full rounded border border-gray-700">
                    </div>
                    <div>
                        <label for="checker-func-${index}" class="block font-semibold mb-2">Checker Function (calc${index + 1})</label>
                        <textarea id="checker-func-${index}" class="w-full h-64 p-2 bg-gray-700 rounded" placeholder="function calc${index + 1}(answer) { ... }">${checkerFunctions[`calc${index + 1}`] || ''}</textarea>
                    </div>
                </div>
            `;
            container.innerHTML += slideEditorHTML;
        });
    }

    async function saveAssignment() {
        const saveBtn = document.getElementById('saveBtn');
        try {
            saveBtn.textContent = "Saving...";
            
            const checkerFunctions = {};
            assignmentData.slideIds.forEach((id, index) => {
                const funcContent = document.getElementById(`checker-func-${index}`).value;
                if (funcContent.trim()) {
                    checkerFunctions[`calc${index + 1}`] = funcContent;
                }
            });

            await db.collection("assignments").doc(assignmentId).update({
                slideIds: assignmentData.slideIds, // Save the auto-fetched IDs
                checkerFunctions: checkerFunctions
            });

            showToast("Assignment saved successfully!");

        } catch (error) {
            console.error("Error saving assignment:", error);
            showToast("Error saving. See console for details.");
        } finally {
            saveBtn.textContent = "Save Assignment";
        }
    }
    
    function showToast(message) { var x = document.getElementById("toast"); x.innerHTML = message; x.className = "show"; setTimeout(function(){ x.className = x.className.replace("show", ""); }, 3000); }
    document.getElementById('signOutButton').onclick = () => { google.accounts.id.disableAutoSelect(); location.reload(); };
</script>
</body>
</html>

