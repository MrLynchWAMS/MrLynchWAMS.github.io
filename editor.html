<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assignment Editor</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üë©‚ÄçüöÄ</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js" async defer></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <style>
        .hidden { display: none; }
        textarea { font-family: monospace; resize: vertical; }
        @keyframes fade-in-right { from { opacity: 0; transform: translateX(100%); } to { opacity: 1; transform: translateX(0); } }
        @keyframes fade-out-right { from { opacity: 1; transform: translateX(0); } to { opacity: 0; transform: translateX(100%); } }
        .animate-fade-in-right { animation: fade-in-right 0.5s ease-out forwards; }
        .animate-fade-out-right { animation: fade-out-right 0.5s ease-out forwards; }
        #toast-wrapper { position: fixed; top: 1rem; right: 1rem; z-index: 50; display: flex; flex-direction: column; gap: 0.5rem; }
    </style>
</head>
<body class="bg-gray-800 text-gray-200 font-sans">
    <div id="loading-overlay" class="fixed inset-0 bg-gray-800 flex items-center justify-center z-50">
        <p class="text-white text-xl animate-pulse">Loading Editor...</p>
    </div>

    <div id="app-container" class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8 hidden">
        <!-- Header -->
        <header class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-white">Assignment Editor</h1>
            <div>
                <a href="assignments.html" class="text-blue-400 hover:text-blue-300 mr-4">Back to Assignments</a>
                <button id="signOutButton" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Sign Out</button>
            </div>
        </header>

        <!-- Assignment Metadata -->
        <div class="bg-gray-900 p-6 rounded-lg shadow-lg mb-6">
            <h2 class="text-xl font-semibold mb-4 border-b border-gray-700 pb-2">Assignment Details</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="assignmentName" class="block text-sm font-medium text-gray-400">Assignment Name</label>
                    <input type="text" id="assignmentName" class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-white">
                </div>
                <div>
                    <label for="postSubmissionRule" class="block text-sm font-medium text-gray-400">After Submission</label>
                    <select id="postSubmissionRule" class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-white">
                        <option value="open">Allow changes and re-checking</option>
                        <option value="lock">Lock answers, allow review</option>
                        <option value="hide">Hide assignment, show summary only</option>
                    </select>
                </div>
                <div>
                    <label for="slideId" class="block text-sm font-medium text-gray-400">Google Slide ID (Optional)</label>
                    <input type="text" id="slideId" class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-white" placeholder="Enter Google Slide presentation ID">
                </div>
                <div id="class-times-container">
                    <label class="block text-sm font-medium text-gray-400">Class Start Times</label>
                    <div id="classTimesList" class="mt-1 space-y-2">
                        <!-- Class times will be added here -->
                    </div>
                    <button id="addClassTimeBtn" class="mt-2 text-sm text-blue-400 hover:text-blue-300">+ Add Time</button>
                </div>
            </div>
        </div>

        <!-- Questions Editor -->
        <div class="bg-gray-900 p-6 rounded-lg shadow-lg">
            <div class="flex justify-between items-center mb-4 border-b border-gray-700 pb-2">
                 <h2 class="text-xl font-semibold">Questions</h2>
                 <button id="addQuestionBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">Add Question</button>
            </div>
            <div id="questionsContainer" class="space-y-4">
                <!-- Questions will be dynamically added here -->
            </div>
        </div>
        
        <footer class="mt-8 flex justify-end">
            <button id="saveAssignmentBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg text-lg">Save Assignment</button>
        </footer>
    </div>

    <!-- Question Template -->
    <template id="questionTemplate">
        <div class="question-card bg-gray-800 p-4 border border-gray-700 rounded-lg">
            <div class="flex justify-between items-center mb-3">
                <span class="question-title font-bold text-lg">Question</span>
                <button class="deleteQuestionBtn bg-red-600 hover:bg-red-700 text-white font-bold py-1 px-3 rounded-md">Delete</button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-400">Question Prompt (supports HTML)</label>
                    <textarea class="questionPrompt w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm p-2 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-white" rows="3"></textarea>
                </div>
                
                <!-- Answer Checking UI -->
                <div>
                    <div class="flex items-center justify-between">
                        <label class="block text-sm font-medium text-gray-400">Answer Checking Code</label>
                        <div class="flex items-center space-x-1 p-1 bg-gray-700 rounded-lg">
                            <button class="mode-toggle-btn simple-mode-btn bg-indigo-600 text-white rounded-md px-3 py-1 text-sm font-semibold">Simple</button>
                            <button class="mode-toggle-btn advanced-mode-btn bg-transparent text-gray-300 rounded-md px-3 py-1 text-sm font-semibold">Advanced</button>
                        </div>
                    </div>

                    <!-- Simple Mode UI -->
                    <div class="simple-mode-ui mt-2 p-3 bg-gray-700/50 border border-gray-600 rounded-lg space-y-4">
                       <div class="rule-groups-container space-y-4">
                           <!-- Rule groups will be dynamically added here -->
                       </div>
                       <button class="add-rule-group-btn mt-2 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg text-sm">+ Add Rule Group</button>
                       <div class="mt-4">
                            <label class="block text-xs font-medium text-gray-500">Live Code Preview (read-only)</label>
                            <pre class="bg-gray-900 text-white p-2 rounded-md text-xs overflow-x-auto h-32"><code class="live-code-preview"></code></pre>
                        </div>
                    </div>

                    <!-- Advanced Mode UI (the original textarea) -->
                    <div class="advanced-mode-ui hidden">
                        <textarea class="answerCheckingCode w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm p-2 mt-1 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-white" rows="8"></textarea>
                    </div>
                </div>

            </div>
        </div>
    </template>
    
    <div id="toast-wrapper"></div>
    
    <script>
    // --- Firebase and Auth Initialization ---
    const firebaseConfig = {
        apiKey: "YOUR_API_KEY",
        authDomain: "YOUR_AUTH_DOMAIN",
        projectId: "iterated-93338",
        storageBucket: "YOUR_STORAGE_BUCKET",
        messagingSenderId: "YOUR_SENDER_ID",
        appId: "YOUR_APP_ID"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    let currentUser = null;

    // --- DOM Elements ---
    const loadingOverlay = document.getElementById('loading-overlay');
    const appContainer = document.getElementById('app-container');
    const assignmentNameEl = document.getElementById('assignmentName');
    const postSubmissionRuleEl = document.getElementById('postSubmissionRule');
    const slideIdEl = document.getElementById('slideId');
    const classTimesList = document.getElementById('classTimesList');
    const addClassTimeBtn = document.getElementById('addClassTimeBtn');
    const questionsContainer = document.getElementById('questionsContainer');
    const questionTemplate = document.getElementById('questionTemplate');
    const addQuestionBtn = document.getElementById('addQuestionBtn');
    const saveAssignmentBtn = document.getElementById('saveAssignmentBtn');
    
    let assignmentId = null;

    // --- Auth State ---
    auth.onAuthStateChanged(user => {
        loadingOverlay.classList.add('hidden'); // Hide loader once auth check completes

        if (user) {
            currentUser = user;
            appContainer.classList.remove('hidden'); // Show the main content
            
            const urlParams = new URLSearchParams(window.location.search);
            assignmentId = urlParams.get('id');
            if (assignmentId) {
                loadAssignment(assignmentId);
            } else {
                addQuestion(1);
            }
        } else {
            // Only redirect if user is truly not logged in after check.
            window.location.href = 'assignments.html';
        }
    });

    // --- Core Logic: Load, Save, Add/Delete Questions & Class Times ---

    async function loadAssignment(id) {
        try {
            const doc = await db.collection('assignments').doc(id).get();
            if (doc.exists) {
                const data = doc.data();
                assignmentNameEl.value = data.name || '';
                postSubmissionRuleEl.value = data.postSubmissionRule || 'open';
                slideIdEl.value = data.slideId || '';
                
                classTimesList.innerHTML = '';
                if(data.classTimes) {
                    data.classTimes.forEach(time => addClassTime(time));
                }

                questionsContainer.innerHTML = '';
                if (data.questions && data.questions.length > 0) {
                    data.questions.forEach((q, index) => {
                        addQuestion(index + 1, q);
                    });
                } else {
                    addQuestion(1);
                }
            } else {
                 showToast("Assignment not found.", {color: 'red'});
                 setTimeout(() => window.location.href = 'assignments.html', 2000);
            }
        } catch (error) {
            console.error("Error loading assignment:", error);
            showToast("Failed to load assignment.", {color: 'red'});
        }
    }
    
    function addClassTime(time = null) {
        const div = document.createElement('div');
        div.className = 'flex items-center space-x-2';
        const input = document.createElement('input');
        input.type = 'datetime-local';
        input.className = 'class-time-input bg-gray-700 border border-gray-600 rounded-md shadow-sm py-1 px-2 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-white';
        if(time) input.value = time;
        const removeBtn = document.createElement('button');
        removeBtn.textContent = 'Remove';
        removeBtn.className = 'text-red-400 hover:text-red-300 text-sm';
        removeBtn.onclick = () => div.remove();
        div.appendChild(input);
        div.appendChild(removeBtn);
        classTimesList.appendChild(div);
    }

    function addQuestion(number, data = null) {
        const clone = questionTemplate.content.cloneNode(true);
        const questionCard = clone.querySelector('.question-card');
        questionCard.dataset.questionNumber = number;

        const title = questionCard.querySelector('.question-title');
        title.textContent = `Question ${number}`;

        const prompt = questionCard.querySelector('.questionPrompt');
        const codeEl = questionCard.querySelector('.answerCheckingCode');
        
        if(data) {
            prompt.value = data.prompt || '';
            codeEl.value = data.code || getDefaultAnswerCheckerCode();
        } else {
            codeEl.value = getDefaultAnswerCheckerCode();
        }
        
        // Always add a default rule group if the card is new, then generate code.
        if (!data) {
            const container = questionCard.querySelector('.rule-groups-container');
            if (container.children.length === 0) {
                container.appendChild(createRuleGroupElement(1));
            }
        }
        generateCodeFromUI(questionCard);


        questionsContainer.appendChild(clone);
        renumberQuestions();
    }
    
    function renumberQuestions() {
        const questions = questionsContainer.querySelectorAll('.question-card');
        questions.forEach((q, index) => {
            const number = index + 1;
            q.dataset.questionNumber = number;
            q.querySelector('.question-title').textContent = `Question ${number}`;
        });
    }

    async function saveAssignment() {
        if (!assignmentNameEl.value.trim()) {
            showToast("Please enter an assignment name.", {color: 'red'});
            return;
        }

        saveAssignmentBtn.disabled = true;
        saveAssignmentBtn.textContent = 'Saving...';

        const questions = [];
        document.querySelectorAll('.question-card').forEach(card => {
            questions.push({
                prompt: card.querySelector('.questionPrompt').value,
                code: card.querySelector('.answerCheckingCode').value,
            });
        });

        const classTimes = Array.from(document.querySelectorAll('.class-time-input')).map(input => input.value).filter(Boolean);

        const assignmentData = {
            name: assignmentNameEl.value.trim(),
            postSubmissionRule: postSubmissionRuleEl.value,
            slideId: slideIdEl.value.trim(),
            classTimes: classTimes,
            questions: questions,
            owner: currentUser.uid,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        try {
            if (assignmentId) {
                await db.collection('assignments').doc(assignmentId).update(assignmentData);
                 showToast("Assignment updated successfully!", {color: 'green'});
            } else {
                const docRef = await db.collection('assignments').add({
                    ...assignmentData,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                assignmentId = docRef.id;
                history.pushState(null, '', `?id=${assignmentId}`);
                showToast("Assignment saved successfully!", {color: 'green'});
            }
        } catch (error) {
            console.error("Error saving assignment:", error);
            showToast("Error saving assignment.", {color: 'red'});
        } finally {
            saveAssignmentBtn.disabled = false;
            saveAssignmentBtn.textContent = 'Save Assignment';
        }
    }

    function getDefaultAnswerCheckerCode() {
        return `// Auto-generated by Simple Editor. Switch to Advanced Mode to edit directly.
function checkAnswer(studentAnswer) {
    let score = 0;
    const maxScore = 100;
    const answer = typeof studentAnswer === 'string' ? studentAnswer.toLowerCase() : studentAnswer;

    // From Rule Group 1
    if (false) { // Add conditions in Simple Mode
        score += 100;
    }

    // Return final score, ensuring it doesn't exceed maxScore.
    return { score: Math.min(score, maxScore), maxScore: maxScore };
}`;
    }

    // --- Event Listeners ---
    addQuestionBtn.addEventListener('click', () => {
        const nextQuestionNumber = questionsContainer.children.length + 1;
        addQuestion(nextQuestionNumber);
    });

    questionsContainer.addEventListener('click', e => {
        if (e.target.classList.contains('deleteQuestionBtn')) {
            e.target.closest('.question-card').remove();
            renumberQuestions();
        }
    });

    saveAssignmentBtn.addEventListener('click', saveAssignment);
    addClassTimeBtn.addEventListener('click', () => addClassTime());
    
    // --- New Simple Rule Builder Logic ---

    questionsContainer.addEventListener('click', (e) => {
        const questionCard = e.target.closest('.question-card');
        if (!questionCard) return;

        // Mode Toggling
        if (e.target.classList.contains('mode-toggle-btn')) {
            const isSimple = e.target.classList.contains('simple-mode-btn');
            
            const simpleBtn = questionCard.querySelector('.simple-mode-btn');
            const advBtn = questionCard.querySelector('.advanced-mode-btn');
            const simpleUI = questionCard.querySelector('.simple-mode-ui');
            const advUI = questionCard.querySelector('.advanced-mode-ui');

            if (isSimple) {
                simpleBtn.classList.add('bg-indigo-600', 'text-white');
                simpleBtn.classList.remove('bg-transparent', 'text-gray-300');
                advBtn.classList.add('bg-transparent', 'text-gray-300');
                advBtn.classList.remove('bg-indigo-600', 'text-white');
                simpleUI.classList.remove('hidden');
                advUI.classList.add('hidden');
            } else { // Advanced mode
                advBtn.classList.add('bg-indigo-600', 'text-white');
                advBtn.classList.remove('bg-transparent', 'text-gray-300');
                simpleBtn.classList.add('bg-transparent', 'text-gray-300');
                simpleBtn.classList.remove('bg-indigo-600', 'text-white');
                advUI.classList.remove('hidden');
                simpleUI.classList.add('hidden');
            }
        }
        
        if(e.target.classList.contains('add-rule-group-btn')) {
            const container = questionCard.querySelector('.rule-groups-container');
            container.appendChild(createRuleGroupElement(container.children.length + 1));
            generateCodeFromUI(questionCard);
        }
        
        if(e.target.classList.contains('add-condition-btn')) {
            const conditionsContainer = e.target.previousElementSibling;
            conditionsContainer.appendChild(createConditionElement());
            generateCodeFromUI(questionCard);
        }
        
        if(e.target.classList.contains('delete-btn')) {
            e.target.parentElement.remove();
            generateCodeFromUI(questionCard);
        }
        
        if (e.target.classList.contains('delete-group-btn')) {
            e.target.closest('.rule-group').remove();
            generateCodeFromUI(questionCard);
        }
    });

    questionsContainer.addEventListener('change', (e) => {
        const questionCard = e.target.closest('.question-card');
        if (questionCard && e.target.closest('.simple-mode-ui')) {
            generateCodeFromUI(questionCard);
        }
    });
    
    questionsContainer.addEventListener('keyup', (e) => {
        const questionCard = e.target.closest('.question-card');
        if (questionCard && e.target.closest('.simple-mode-ui')) {
            generateCodeFromUI(questionCard);
        }
    });

    function createRuleGroupElement(number) {
        const div = document.createElement('div');
        div.className = 'rule-group bg-gray-800 p-3 rounded-lg border border-gray-600 space-y-3';
        div.innerHTML = `
            <div class="flex justify-between items-center">
                <h4 class="font-semibold text-white">Rule Group ${number}</h4>
                <button class="delete-group-btn text-red-400 hover:text-red-300 font-bold text-sm">Remove Group</button>
            </div>
            <div class="flex items-center space-x-2">
                <label class="text-sm">If conditions are met, award</label>
                <input type="number" class="rule-points w-20 bg-gray-700 border border-gray-600 rounded-md p-1 text-center" value="100">
                <label class="text-sm">points.</label>
            </div>
            <div class="flex items-center space-x-2">
                <label class="text-sm">Conditions in this group require:</label>
                <select class="group-connector bg-gray-700 border border-gray-600 rounded-md p-1 text-sm">
                    <option value="&&">All to be true (AND)</option>
                    <option value="||">Any to be true (OR)</option>
                </select>
            </div>
            <div class="conditions-container space-y-2">
                ${createConditionElement().outerHTML}
            </div>
            <button class="add-condition-btn text-sm text-blue-400 hover:text-blue-300">+ Add Condition</button>
        `;
        return div;
    }

    function createConditionElement() {
        const div = document.createElement('div');
        div.className = 'condition-row flex items-center space-x-2 bg-gray-900/50 p-2 rounded-md';
        div.innerHTML = `
            <select class="cond-type bg-gray-700 border border-gray-600 rounded-md p-1 text-sm">
                <option value="text">Text</option>
                <option value="number">Number</option>
            </select>
            <select class="cond-operator bg-gray-700 border border-gray-600 rounded-md p-1 text-sm">
                <option value="contains">contains</option>
                <option value="not_contains">does not contain</option>
                <option value="equals_str">is exactly</option>
            </select>
            <div class="cond-value-wrapper flex-grow">
                <input type="text" class="cond-value w-full bg-gray-700 border border-gray-600 rounded-md p-1 text-sm" placeholder="keyword(s), comma-separated">
                <div class="text-options hidden text-xs mt-1">
                    <label>Require: </label>
                    <select class="text-bool bg-gray-700 border border-gray-600 rounded-md p-0.5 text-sm">
                        <option value="||">Any (OR)</option>
                        <option value="&&">All (AND)</option>
                    </select>
                </div>
            </div>
            <button class="delete-btn text-red-400 hover:text-red-300 font-bold text-xl leading-none">&times;</button>
        `;
        div.querySelector('.cond-type').addEventListener('change', e => {
            const operatorSelect = div.querySelector('.cond-operator');
            const valueWrapper = div.querySelector('.cond-value-wrapper');
            const type = e.target.value;
            if(type === 'number') {
                operatorSelect.innerHTML = `<option value="==">is equal to</option><option value="!=">is not equal to</option><option value=">">is greater than</option><option value="<">is less than</option>`;
                valueWrapper.innerHTML = `<input type="number" class="cond-value w-full bg-gray-700 border border-gray-600 rounded-md p-1 text-sm" placeholder="a number">`;
            } else { // text
                 operatorSelect.innerHTML = `<option value="contains">contains</option><option value="not_contains">does not contain</option><option value="equals_str">is exactly</option>`;
                 valueWrapper.innerHTML = `<input type="text" class="cond-value w-full bg-gray-700 border border-gray-600 rounded-md p-1 text-sm" placeholder="keyword(s), comma-separated"><div class="text-options hidden text-xs mt-1"><label>Require: </label><select class="text-bool bg-gray-700 border border-gray-600 rounded-md p-0.5 text-sm"><option value="||">Any (OR)</option><option value="&&">All (AND)</option></select></div>`;
            }
        });
        div.addEventListener('keyup', e => {
            if (e.target.classList.contains('cond-value')) {
                const operator = div.querySelector('.cond-operator').value;
                const textOptions = div.querySelector('.text-options');
                if (!textOptions) return;
                if (operator === 'contains' || operator === 'not_contains') {
                    if (e.target.value.includes(',')) textOptions.classList.remove('hidden');
                    else textOptions.classList.add('hidden');
                } else {
                    textOptions.classList.add('hidden');
                }
            }
        });
        return div;
    }

    function generateCodeFromUI(questionCard) {
        const ruleGroups = questionCard.querySelectorAll('.rule-group');
        let code = `// Auto-generated by Simple Editor. Switch to Advanced Mode to edit directly.\n`;
        code += `function checkAnswer(studentAnswer) {\n`;
        code += `    let score = 0;\n`;
        let totalMaxScore = 0;
        ruleGroups.forEach(group => { totalMaxScore += Number(group.querySelector('.rule-points').value) || 0; });
        code += `    const maxScore = ${totalMaxScore || 100};\n`;
        code += `    const answer = typeof studentAnswer === 'string' ? studentAnswer.toLowerCase() : studentAnswer;\n\n`;
        
        ruleGroups.forEach((group, index) => {
            const points = Number(group.querySelector('.rule-points').value) || 0;
            const groupConnector = group.querySelector('.group-connector').value; // '&&' or '||'
            let groupConditions = [];
            group.querySelectorAll('.condition-row').forEach(cond => {
                const type = cond.querySelector('.cond-type').value;
                const op = cond.querySelector('.cond-operator').value;
                const val = cond.querySelector('.cond-value').value.trim();
                if (!val) return;
                if (type === 'text') {
                    const keywords = val.split(',').map(k => k.trim().toLowerCase()).filter(Boolean);
                    if (keywords.length > 1 && (op === 'contains' || op === 'not_contains')) {
                         const textBool = cond.querySelector('.text-bool').value;
                         const keywordConditions = keywords.map(k => `${op === 'not_contains' ? '!' : ''}answer.includes("${k.replace(/"/g, '\\"')}")`);
                         groupConditions.push(`(${keywordConditions.join(` ${textBool} `)})`);
                    } else if (keywords.length > 0) {
                        const keyword = keywords[0];
                        if (op === 'contains') groupConditions.push(`answer.includes("${keyword.replace(/"/g, '\\"')}")`);
                        else if (op === 'not_contains') groupConditions.push(`!answer.includes("${keyword.replace(/"/g, '\\"')}")`);
                        else if (op === 'equals_str') groupConditions.push(`answer === "${keyword.replace(/"/g, '\\"')}"`);
                    }
                } else if (type === 'number' && !isNaN(parseFloat(val))) {
                    groupConditions.push(`Number(answer) ${op} ${parseFloat(val)}`);
                }
            });
            if (groupConditions.length > 0) {
                const ifStatement = index === 0 ? 'if' : 'else if';
                code += `    // From Rule Group ${index + 1}\n`;
                code += `    ${ifStatement} (${groupConditions.join(` ${groupConnector} `)}) {\n`;
                code += `        score += ${points};\n`;
                code += `    }\n\n`;
            }
        });

        code += `    // Return final score, ensuring it doesn't exceed maxScore.\n`;
        code += `    return { score: Math.min(score, maxScore), maxScore: maxScore };\n`;
        code += `}`;
        
        questionCard.querySelector('.answerCheckingCode').value = code;
        const previewEl = questionCard.querySelector('.live-code-preview');
        if (previewEl) previewEl.textContent = code;
    }

    // --- Utility: Toast Notifications ---
    function showToast(message, options = {}) {
        const { color = 'default', duration = 3000 } = options;
        const wrapper = document.getElementById('toast-wrapper');
        if (!wrapper) return;
        const toast = document.createElement('div');
        toast.className = 'flex items-center justify-between p-4 rounded-lg shadow-lg text-white max-w-sm animate-fade-in-right';
        const colors = { default: 'bg-gray-700', green: 'bg-green-600', red: 'bg-red-600', blue: 'bg-blue-600' };
        toast.classList.add(colors[color] || colors['default']);
        const messageSpan = document.createElement('span');
        messageSpan.textContent = message;
        toast.appendChild(messageSpan);
        const closeButton = document.createElement('button');
        closeButton.innerHTML = '&times;';
        closeButton.className = 'ml-4 text-2xl font-bold leading-none hover:text-gray-300 focus:outline-none';
        let timeoutId = null;
        const dismiss = () => {
            if (timeoutId) clearTimeout(timeoutId);
            toast.classList.remove('animate-fade-in-right');
            toast.classList.add('animate-fade-out-right');
            toast.addEventListener('animationend', () => toast.remove());
        };
        closeButton.onclick = dismiss;
        toast.appendChild(closeButton);
        wrapper.appendChild(toast);
        timeoutId = setTimeout(dismiss, duration);
    }
    document.getElementById('signOutButton').onclick = () => { auth.signOut(); };

</script>
</body>
</html>

